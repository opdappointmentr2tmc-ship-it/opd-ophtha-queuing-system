<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ophthalmology Clinic Queue Dashboard</title>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%; width: 100%;
    font-family: "Segoe UI", Tahoma, Arial, sans-serif;
    background: linear-gradient(135deg,#e6e8eb,#cfd3d6);
    overflow: hidden; display: flex; flex-direction: column;
  }
/* --------- HEADER --------- */
#topHeader {
  background: #4CAF50;
  color: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 2px 5px; /* reduced padding */
  box-shadow: 0 2px 6px rgba(0,0,0,0.08); /* smaller shadow */
  height: 100px; /* fixed smaller height */
}

#headerCenter {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0;
}

#headerRow {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px; /* smaller gap */
}

#headerTitle {
  font-size: 1.7em;   /* slightly bigger */
  font-weight: 900;   /* bold */
  text-align: center;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.25);
  white-space: nowrap;
}

#headerClock {
  font-size: 1.3em;   /* slightly bigger */
  font-weight: 700;   /* bold */
  text-shadow: 1px 1px 3px rgba(0,0,0,0.25);
  margin-top: 2px;
}
#headerLogoLeft,
#headerLogoRight {
    height: 45px; 
  width: auto;
  object-fit: contain;
  filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.2));
}

/* Responsive tweaks */
@media (max-width:900px){
  #headerTitle { font-size: 1.3em; }
  #headerLogoLeft, #headerLogoRight { height: 35px; }
  #headerClock { font-size: 1em; }
}
@media (max-width:600px){
  #headerTitle { font-size: 1.1em; }
  #headerLogoLeft, #headerLogoRight { height: 30px; }
  #headerClock { font-size: 0.9em; }
}
@media (max-width:500px){
  #headerTitle { font-size: 1em; }
  #headerLogoLeft, #headerLogoRight { height: 25px; }
  #headerClock { font-size: 0.8em; }
}

  /* --------- MAIN LAYOUT --------- */
  #mainContainer { display:flex; flex-direction:column; gap:10px; padding:10px 20px; flex:1 1 auto; overflow:hidden; }
#gridsContainer {
  display: flex;
  flex-direction: column;
  width: 100%;
  flex: 1;
}
#centerPanel {
  display: grid;
  grid-template-columns: 1fr 1fr; /* 50% / 50% */
  gap: 15px;
  width: 100%;
  flex: 1;
}



  .area-header { font-size:2em; font-weight:700; text-align:center; border-radius:25px; padding:15px; color:#fff; box-shadow:0 8px 25px rgba(0,0,0,0.08); }

  .title { font-size:2em; font-weight:700; margin-bottom:12px; text-align:center; }

  #table1Box { background:#007bff; color:#fff; }
  #num1List { display:grid; grid-template-columns:repeat(2,1fr); grid-auto-rows:minmax(80px,auto); gap:10px; width:100%; overflow-y:auto; }

.queue-number-consult {
  display: flex;
  flex-direction: column; /* stack prefix above number */
  justify-content: center;
  align-items: center;
  flex: 1 1 auto;
  width: 100%;
  max-height: 100%;
  overflow: hidden;
  text-align: center;
  font-weight: 900;
}

.queue-number-consult .prefix {
  font-size: 1.5em; /* stays the same */
  margin-bottom: 5px;
}

.queue-number-consult .main-number {
  font-size: clamp(5rem, 25vw, 12rem); /* much bigger, scales with screen */
  font-weight: 900; /* extra bold */
}






  .queue-number.pulse, .queue-number-consult.pulse {
  animation: highlightPulse 1s ease-in-out;
}

@keyframes highlightPulse {
  0% { box-shadow: 0 0 35px rgba(0,123,255,0.8); transform:scale(1); }
  50% { box-shadow: 0 0 70px rgba(0,123,255,0.9); transform:scale(1.15); }
  100% { box-shadow: 0 0 35px rgba(0,123,255,0.8); transform:scale(1); }
}


  #owcContainer {
    background:rgba(245,245,245,0.55); backdrop-filter:blur(8px); border-radius:25px;   padding: 10px 20px; /* reduce top/bottom padding */
    flex:0 0 auto; overflow:hidden; box-shadow:0 8px 25px rgba(0,0,0,0.08); margin-top:10px;
    transition:opacity .35s ease, max-height .4s ease, transform .35s ease; max-height:0; opacity:0; transform:translateY(-12px) scale(.995); pointer-events:none;
  }
  #owcContainer.visible { opacity:1; transform:translateY(0) scale(1); pointer-events:auto; }
  #owcContainer.hidden { opacity:0; transform:translateY(-12px) scale(.995); pointer-events:none; }
 #owcContainer h2 {
    font-size: 2em;
    margin: 5px 0 15px 0; /* top margin smaller */
    color: #d9534f;
    text-align: center;
}
#owcList {
  display: grid;
  gap: 10px;
  align-items: start;
  grid-template-columns: repeat(auto-fit, minmax(calc(10% - 10px), 1fr));
}

@media (max-width:1200px){ #owcList { grid-template-columns: repeat(6,1fr); } }
@media (max-width:700px) { #owcList { grid-template-columns: repeat(4,1fr); } }
@media (max-width:500px) { #owcList { grid-template-columns: repeat(2,1fr); } }

  .owc-item { font-size:1.6em; padding:12px; border-radius:15px; background:rgba(217,83,79,0.85); text-align:center; font-weight:700; color:#fff; animation:pulse 1.5s infinite; opacity:0; transform:translateY(8px); }
  @keyframes pulse { 0% { box-shadow:0 0 10px rgba(217,83,79,0.7);} 50% { box-shadow:0 0 25px rgba(217,83,79,0.7);} 100% { box-shadow:0 0 10px rgba(217,83,79,0.7);} }

  #startOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); display:flex; justify-content:center; align-items:center; z-index:1000; }
  #startOverlay button { padding:20px 40px; font-size:2em; border:none; border-radius:15px; background:#007bff; color:white; cursor:pointer; }

  @media (max-width:1200px){ #gridsContainer{flex-direction:column;} #centerPanel{grid-template-rows:auto auto auto;} #owcList{grid-template-columns:repeat(3,1fr);} }
  @media (max-width:700px){ #owcList{grid-template-columns:repeat(2,1fr);} .queue-number-consult{font-size: clamp(3.2rem, 18vw, 6rem); } .queue-number{font-size: clamp(2rem, 8vw, 2.8rem); } }

#centerPanel .table-box {
  background: #28a745; /* green background */
  color: #fff;
  border-radius: 25px;
  display: flex;
  flex-direction: column;
  justify-content: center; /* centers the number vertically */
  align-items: center;
  position: relative; /* allows title to be positioned at bottom */
  overflow: hidden;
  min-height: 150px;
  padding: 10px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.08);
}

.queue-number-consult {
  font-size: 5rem; /* scales automatically */
  display: flex;
  justify-content: center;
  align-items: center;
  flex: 1 1 auto; /* grows to fill space */
  width: 100%;
  max-height: 100%;
  overflow: hidden;
}

.table-box .title {
  position: absolute;
  bottom: 10px; /* sticks to bottom */
  left: 50%;
  transform: translateX(-50%);
  font-size: 2em; /* much bigger */
  font-weight: 900; /* bold */
  text-align: center;
  padding: 6px 12px;
  border-radius: 12px;
  background: rgba(0,0,0,0.15); /* subtle contrast */
  width: calc(100% - 20px);
}
@media (max-width:900px){
  .table-box .title { font-size: 1.8em; }
}
@media (max-width:600px){
  .table-box .title { font-size: 1.5em; }
}
@media (max-width:500px){
  .table-box .title { font-size: 1.2em; }
}

</style>
</head>
<body>

<!-- -------- HEADER -------- -->
<div id="topHeader">
  <div id="headerCenter">
    <div id="headerRow">
      <img id="headerLogoLeft" src="R2TMC_LOGO-removebg-preview.png" alt="Hospital Logo">
      <div id="headerTitle">OPHTHALMOLOGY CLINIC</div>
      <img id="headerLogoRight" src="dohlogo.png" alt="Hospital Logo">
    </div>
    <div id="headerClock">00:00:00</div>
  </div>
</div>

<div id="startOverlay">
  <button id="startBtn">Start Dashboard</button>
</div>

<div id="mainContainer" style="display:none;">
  <div id="gridsContainer">

<div id="centerPanel">
  <div class="table-box">
    <div class="queue-number-consult" id="num1">
      <div class="prefix"></div>
      <div class="main-number"></div>
    </div>
    <div class="title">Table 1</div>
  </div>

  <div class="table-box">
    <div class="queue-number-consult" id="num2">
      <div class="prefix"></div>
      <div class="main-number"></div>
    </div>
    <div class="title">Table 2</div>
  </div>
</div>
  <div id="owcContainer" class="hidden">
    <h2>OUT WHEN CALLED</h2>
    <div id="owcList"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

/* ---------- FIREBASE CONFIG ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDHTIJeBJEwELFfmLEHcs5Wvr9tlMSvLyw",
  authDomain: "r2tmc-opd-ophtha-qs.firebaseapp.com",
  databaseURL: "https://r2tmc-opd-ophtha-qs-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "r2tmc-opd-ophtha-qs",
  storageBucket: "r2tmc-opd-ophtha-qs.firebasestorage.app",
  messagingSenderId: "1046917289372",
  appId: "1:1046917289372:web:65b5748464233290646459",
  measurementId: "G-Z8XTRQEGPQ"
};

const app = initializeApp(firebaseConfig);

const db = getDatabase(app);

/* ---------- LIVE CLOCK ---------- */
function updateClock() {
  const now = new Date();
  const timeStr = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
  document.getElementById("headerClock").textContent = timeStr;
}
setInterval(updateClock, 1000);
updateClock();

/* ---------- SPEECH SYSTEM ---------- */
let voices = [];
const preferredVoiceNames = ["Google US English","Google UK English Male","Google UK English Female"];
function loadVoices() { voices = window.speechSynthesis.getVoices().filter(v => preferredVoiceNames.includes(v.name)); }
loadVoices();
if (speechSynthesis.onvoiceschanged !== undefined) { speechSynthesis.onvoiceschanged = loadVoices; }
function getRandomVoice() { if(!voices.length) return null; return voices[Math.floor(Math.random()*voices.length)]; }

const speechQueue = [];
let isSpeaking = false;
function speakQueuedNumber(num, table, action="Now serving"){
  speechQueue.push({num,table,action});
  if(!isSpeaking) processSpeechQueue();
}
function processSpeechQueue(){
  if(speechQueue.length===0){ isSpeaking=false; return; }
  isSpeaking=true;
  const {num,table,action} = speechQueue.shift();
  if(!num) return processSpeechQueue();
  const [prefix,numStr] = (num||"").split("-");
  const spokenPrefix = prefix && prefix.toUpperCase() === "OP" ? "O P" : prefix;
  const number = parseInt(numStr||0,10) || numStr || num;
  const area = table===1?"Vital Sign Area":"Consultation Area";
  const text = action 
    ? `${action}, ${spokenPrefix?spokenPrefix+' ':''}number ${number}. Please proceed to the Ophthalmology Clinic Room 201 table ${table}.` 
    : num;
  const utter = new SpeechSynthesisUtterance(text);
  utter.rate=1; utter.pitch=1;
  if(voices.length) utter.voice = getRandomVoice();
  const beep = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=");
  beep.play().then(()=>{ window.speechSynthesis.speak(utter); }).catch(()=>{ window.speechSynthesis.speak(utter); });
  utter.onend = ()=>processSpeechQueue();
}

/* ---------- ANNOUNCE TRACKING ---------- */
let announcedTimestamps = JSON.parse(localStorage.getItem('announcedTimestamps')||'{}');
function shouldAnnounce(num,table){
  if(!num) return false;
  const key = `${table}_${num}`;
  const now = Date.now();
  if(!announcedTimestamps[key] || now - announcedTimestamps[key] > 15000){
    announcedTimestamps[key] = now;
    localStorage.setItem('announcedTimestamps',JSON.stringify(announcedTimestamps));
    return true;
  }
  return false;
}

/* ---------- DASHBOARD VARIABLES ---------- */
const tableColors = { 1:"#28a745",2:"#28a745",3:"#28a745",4:"#28a745",5:"#28a745", vip:"#ff9800" };
function updateVitalDisplayed(numbers){ numbers.forEach(n=>vitalDisplayed.add(n)); localStorage.setItem('vitalDisplayed',JSON.stringify([...vitalDisplayed])); }

/* ---------- TABLES 1-5 ---------- */
function loadTables() {
  const tableIds = [1, 2];

  // Clear old localStorage data immediately
  tableIds.forEach(i => localStorage.removeItem(`table${i}`));

  tableIds.forEach(i => {
    const numEl = document.getElementById(`num${i}`);

    let prefixEl = numEl.querySelector(".prefix");
    let mainEl = numEl.querySelector(".main-number");

    let lastKnown = "";

    onValue(ref(db, `tableNumbers/table${i}`), snap => {
      const val = snap.val();

      if (val === null || val === undefined || val === "-RESET-") {
        prefixEl.textContent = "";
        mainEl.textContent = "";
        numEl.style.background = tableColors[i];
        lastKnown = "";
        localStorage.removeItem(`table${i}`);
        return;
      }

      if (val === "" || val === "-") return;
      if (val === lastKnown) return;

      const [prefix, rawNum] = val.split("-");
      const mainNumber = rawNum ? parseInt(rawNum, 10) : val;
      prefixEl.textContent = prefix || "";
      mainEl.textContent = mainNumber;

      lastKnown = val;
      localStorage.setItem(`table${i}`, val);

      numEl.style.background = tableColors[i];
      numEl.style.color = "#fff";
      numEl.classList.add("pulse");
      setTimeout(() => numEl.classList.remove("pulse"), 1000);

      if (shouldAnnounce(val, i)) {
        speakQueuedNumber(val, i, "Now serving");
      }
    });
  });
}

/* ---------- OWC LIST ---------- */
function loadOWCList(){
  const owcContainer=document.getElementById('owcContainer');
  const owcList=document.getElementById('owcList');
  onValue(ref(db,"owc"), snap=>{
    owcList.innerHTML='';
    if(!snap.exists()){ owcContainer.classList.add('hidden'); owcContainer.classList.remove('visible'); owcContainer.style.maxHeight="0px"; return; }
    const values=Object.values(snap.val()||{});
    const sorted=values.sort((a,b)=>{
      const [pA,nA]=(a.number||"").split("-");
      const [pB,nB]=(b.number||"").split("-");
      if(pA===pB) return parseInt(nA||0)-parseInt(nB||0);
      return (pA||"").localeCompare(pB||"");
    });
    sorted.forEach(e=>{
      const div=document.createElement('div'); div.className='owc-item';
     div.textContent = `${e.number}`;
 owcList.appendChild(div);
      requestAnimationFrame(()=>{ div.style.transition="opacity .28s ease, transform .28s ease"; div.style.opacity=1; div.style.transform="translateY(0)"; });
    });
    if(sorted.length>0){ owcContainer.classList.remove('hidden'); owcContainer.classList.add('visible'); requestAnimationFrame(()=>{ owcContainer.style.maxHeight = owcContainer.scrollHeight + "px"; }); }
    else{ owcContainer.classList.remove('visible'); owcContainer.classList.add('hidden'); owcContainer.style.maxHeight="0px"; }
  });
}

/* ---------- RECALL EVENTS ---------- */
onValue(ref(db,"recallEvents"), snap=>{
  if(!snap.exists()) return;
  const events=Object.values(snap.val());
  events.forEach(e=>{
    let numEl;
    if(e.table===1){ numEl = Array.from(document.querySelectorAll('#num1List .queue-number')).find(d=>d.textContent===e.number); }
    else numEl=document.getElementById('num'+e.table);
    if(numEl){ numEl.classList.add("pulse"); setTimeout(()=>numEl.classList.remove("pulse"),1000); }
    speakQueuedNumber(e.number,e.table,"Now recalling");
  });
  remove(ref(db,"recallEvents"));
});

/* ---------- START DASHBOARD ---------- */
document.getElementById('startBtn').addEventListener('click', ()=>{
  document.getElementById('startOverlay').style.display='none';
  document.getElementById('mainContainer').style.display='flex';
  speakQueuedNumber("Dashboard started",0,"");
  loadTables();
  loadOWCList();
});

</script>
</body>
</html>
